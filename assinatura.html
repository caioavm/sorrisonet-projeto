<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Assinatura ‚Äî SorrisoNet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- TOPO -->
  <header class="topbar">
    <div class="topbar-inner">
      <a class="brand" href="index.html">
        <img src="logotipo_sorriso_net_azul_claro-removebg-preview.png" alt="SorrisoNet">
      </a>

      <button class="btn-primary" onclick="location.href='assinatura.html'">ASSINE J√Å</button>

      <div class="search">
        <input type="search" placeholder="Digite sua pesquisa" />
      </div>

      <nav class="main-nav">
        <a href="area-assinante.html">√ÅREA DO ASSINANTE</a>
        <a href="planos.html">PLANOS</a>
        <a href="agenda_doutores.html">GERENCIAMENTO</a>
        <a href="contato.html">FALE CONOSCO</a>
        <a id="btnLoginLogout" href="login.html">Login</a>
      </nav>
    </div>
  </header>

  <!-- CONTE√öDO -->
  <main class="container" style="padding:32px 0">
    <h1 style="color:var(--primary); margin-bottom:4px;">Finalize sua assinatura</h1>
    <p style="margin-top:0; color:#555;">Escolha o plano, preencha seus dados e confirme o pagamento.</p>

    <form id="form-assinatura" class="checkout">
      <!-- COLUNA ESQUERDA -->
      <section class="card">
        <h2>1) Escolha do plano</h2>
        <div class="plans-list">
          <label class="plan-item">
            <input type="radio" name="plano" value="Basico|99" data-nome="Plano B√°sico" data-valor="99" required>
            <div>
              <strong>Plano B√°sico</strong>
              <span>R$ 99/m√™s</span>
            </div>
          </label>

          <label class="plan-item destaque">
            <input type="radio" name="plano" value="Premium|149" data-nome="Plano Premium" data-valor="149" required>
            <div>
              <strong>Plano Premium</strong>
              <span>R$ 149/m√™s</span>
            </div>
          </label>

          <label class="plan-item">
            <input type="radio" name="plano" value="Familia|249" data-nome="Plano Fam√≠lia" data-valor="249" required>
            <div>
              <strong>Plano Cl√≠nica</strong>
              <span>R$ 249/m√™s</span>
            </div>
          </label>
        </div>
      </section>

      <section class="card">
        <h2>2) Dados do assinante</h2>
        <div class="grid2">
          <div>
            <label for="nome">Nome completo</label>
            <input type="text" id="nome" name="nome" placeholder="Seu nome" required>
          </div>
          <div>
            <label for="cpf">CPF</label>
            <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" required>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label for="email">E-mail</label>
            <input type="email" id="email" name="email" placeholder="voce@email.com" required>
          </div>
          <div>
            <label for="telefone">Telefone</label>
            <input type="tel" id="telefone" name="telefone" placeholder="(11) 90000-0000" required>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label for="cep">CEP</label>
            <input type="text" id="cep" name="cep" placeholder="00000-000">
          </div>
          <div>
            <label for="cidade">Cidade</label>
            <input type="text" id="cidade" name="cidade" placeholder="S√£o Paulo">
          </div>
        </div>

        <label for="endereco">Endere√ßo</label>
        <input type="text" id="endereco" name="endereco" placeholder="Rua, n√∫mero, complemento">
      </section>

      <section class="card">
        <h2>3) Pagamento</h2>

        <div class="pay-tabs">
          <label><input type="radio" name="pagamento" value="cartao" checked> Cart√£o de cr√©dito</label>
          <label><input type="radio" name="pagamento" value="pix"> Pix (simulado)</label>
        </div>

        <!-- CART√ÉO -->
        <div id="box-cartao" class="grid2">
          <div>
            <label for="numero">N√∫mero do cart√£o</label>
            <input type="text" id="numero" name="numero" placeholder="0000 0000 0000 0000">
          </div>
          <div>
            <label for="nome_cartao">Nome impresso</label>
            <input type="text" id="nome_cartao" name="nome_cartao" placeholder="NOME SOBRENOME">
          </div>
          <div>
            <label for="validade">Validade (MM/AA)</label>
            <input type="text" id="validade" name="validade" placeholder="12/29">
          </div>
          <div>
            <label for="cvv">CVV</label>
            <input type="password" id="cvv" name="cvv" placeholder="***">
          </div>
        </div>

        <!-- PIX -->
        <div id="box-pix" style="display:none;">
          <p style="color:#555;">Ao confirmar, mostraremos um QR Code simulado (apenas para demonstra√ß√£o na apresenta√ß√£o).</p>
        </div>

        <label class="terms">
          <input type="checkbox" id="termos" required>
          <span>Li e concordo com os termos da assinatura.</span>
        </label>
      </section>

      <!-- COLUNA DIREITA (RESUMO) -->
      <aside class="summary card">
        <h3>Resumo</h3>
        <ul class="sum-list">
          <li><span>Plano</span><strong id="sum-plano">‚Äî</strong></li>
          <li><span>Valor mensal</span><strong id="sum-valor">R$ 0,00</strong></li>
          <li><span>Taxa de ades√£o</span><strong>R$ 0,00</strong></li>
          <li class="total"><span>Total inicial</span><strong id="sum-total">R$ 0,00</strong></li>
        </ul>

        <button type="submit" class="auth-btn">Confirmar assinatura</button>
        <p class="safe-note">Ambiente simulado e seguro para apresenta√ß√£o.</p>

        <!-- status / erro / sucesso -->
        <p id="statusAssinatura"
           style="text-align:center; margin-top:12px; font-size:14px; color:#555;">
        </p>
      </aside>

    </form>
  </main>

  <!-- RODAP√â -->
  <footer class="site-footer">
    <div class="container">
      <p>¬© SorrisoNet ‚Äî Trabalho acad√™mico</p>
    </div>
  </footer>

  <!-- SCRIPTS -->
  <script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const form          = document.getElementById('form-assinatura');

  const radiosPlano   = [...document.querySelectorAll('input[name="plano"]')];
  const sumPlano      = document.getElementById('sum-plano');
  const sumValor      = document.getElementById('sum-valor');
  const sumTotal      = document.getElementById('sum-total');

  const radiosPay     = [...document.querySelectorAll('input[name="pagamento"]')];
  const boxCartao     = document.getElementById('box-cartao');
  const boxPix        = document.getElementById('box-pix');

  const termos        = document.getElementById('termos');
  const msgStatus     = document.getElementById('statusAssinatura');

  const campoNome     = document.getElementById('nome');
  const campoEmail    = document.getElementById('email');

  const btnLoginLogout = document.getElementById('btnLoginLogout');
  const btnAssineJa    = document.querySelector('.btn-primary'); // o bot√£o azul ASSINE J√Å no header

  // 1. Garante login
  let me = null;
  try {
    me = await requireLogin(); // se n√£o tiver login ele j√° manda pro login.html
  } catch (err) {
    return;
  }

  // 2. Se j√° √© premium:
  if (me.premium === true) {
    // some com o bot√£o "ASSINE J√Å"
    if (btnAssineJa) {
      btnAssineJa.style.display = 'none';
    }

    // Mostra mensagem no lugar do formul√°rio inteiro e impede assinar de novo
    if (msgStatus) {
      msgStatus.textContent = 'Voc√™ j√° √© Premium üòé N√£o precisa assinar novamente.';
      msgStatus.style.color = 'green';
      msgStatus.style.fontSize = '16px';
      msgStatus.style.fontWeight = '600';
    }

    // desabilita o form visualmente
    if (form) {
      form.style.opacity = '0.5';
      form.querySelectorAll('input,button,select,textarea').forEach(el=>{
        el.disabled = true;
      });
    }

    // opcional: redirecionar direto pra √°rea do assinante depois de alguns segundos
    setTimeout(()=>{
      window.location.href = 'area-assinante.html';
    }, 3000);

    // IMPORTANTE: para aqui. n√£o continua com o resto
    return;
  }

  // 3. Se N√ÉO √© premium: deixa continuar, mas j√° preenche nome/email
  if (me && me.nome)   campoNome.value  = me.nome;
  if (me && me.email)  campoEmail.value = me.email;

  // tamb√©m deixa o bot√£o "ASSINE J√Å" vis√≠vel, mas se quiser voc√™ pode esconder mesmo para n√£o premium:
  // (normalmente voc√™ quer MANTER vis√≠vel pra n√£o premium)
  // if (btnAssineJa) btnAssineJa.style.display = 'none';

  // 4. Atualiza bot√£o Login/Sair do topo
  if (btnLoginLogout) {
    const token = localStorage.getItem('token');
    if (token) {
      btnLoginLogout.textContent = 'Sair';
      btnLoginLogout.href = '#';
      btnLoginLogout.onclick = () => { logout(); };
    } else {
      btnLoginLogout.textContent = 'Login';
      btnLoginLogout.href = 'login.html';
    }
  }

  // 5. Pr√©-seleciona plano vindo da URL (?plano=Premium etc)
  const params = new URLSearchParams(window.location.search);
  const planoURL = params.get('plano'); // "Premium", "Basico", "Familia"...

  if (planoURL) {
    const alvo = radiosPlano.find(r =>
      r.value.toLowerCase().startsWith(planoURL.toLowerCase())
    );
    if (alvo) {
      alvo.checked = true;
    }
  }

  function formatarBRL(v){
    return Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  }

  function atualizarResumo(){
    const r = radiosPlano.find(x => x.checked);
    if(!r){
      sumPlano.textContent = '‚Äî';
      sumValor.textContent = 'R$ 0,00';
      sumTotal.textContent = 'R$ 0,00';
      return;
    }
    const [nomePlano, valorPlano] = r.value.split('|');
    sumPlano.textContent = nomePlano;
    sumValor.textContent = formatarBRL(valorPlano);
    sumTotal.textContent = formatarBRL(valorPlano);
  }

  radiosPlano.forEach(r => r.addEventListener('change', atualizarResumo));
  atualizarResumo();

  function updatePay(){
    const pay = radiosPay.find(x=>x.checked)?.value;
    if(pay === 'cartao'){
      boxCartao.style.display = 'grid';
      boxPix.style.display = 'none';
    }else{
      boxCartao.style.display = 'none';
      boxPix.style.display = 'block';
    }
  }
  radiosPay.forEach(r => r.addEventListener('change', updatePay));
  updatePay();

  // 6. Submeter pagamento ‚Üí virar premium
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    if(!termos.checked){
      alert('Voc√™ precisa aceitar os termos.');
      return;
    }

    const planoEscolhido = radiosPlano.find(x=>x.checked);
    if(!planoEscolhido){
      alert('Escolha um plano.');
      return;
    }

    msgStatus.textContent = 'Processando pagamento...';
    msgStatus.style.color = '#555';
    msgStatus.style.fontWeight = '400';

    try {
      // chama nossa rota que marca o usu√°rio como premium
      const resp = await fetch('http://localhost:3000/api/make-premium', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({})
      });

      const data = await resp.json();

      if (!(resp.ok && data.premium === true)) {
        msgStatus.textContent = 'Algo deu errado ao ativar sua assinatura.';
        msgStatus.style.color = 'red';
        console.warn('Resposta inesperada:', data);
        return;
      }

      // confirmar com /api/me
      const meResp = await fetch('http://localhost:3000/api/me', {
        headers: {
          Authorization: 'Bearer ' + localStorage.getItem('token')
        }
      });
      const meData = await meResp.json();

      if (meResp.ok && meData.premium === true) {
        msgStatus.textContent = 'Pagamento aprovado! Agora voc√™ √© Premium ‚úÖ';
        msgStatus.style.color = 'green';
        msgStatus.style.fontWeight = '600';

        // esconde bot√£o ASSINE J√Å imediatamente, j√° que virou premium agora
        if (btnAssineJa) {
          btnAssineJa.style.display = 'none';
        }

        // manda pra √°rea do assinante depois de 3 segundos pra dar tempo de ler
        setTimeout(()=>{
          window.location.href = 'area-assinante.html';
        }, 3000);
      } else {
        msgStatus.textContent = 'Pagamento feito, mas premium n√£o confirmou ainda.';
        msgStatus.style.color = 'red';
        console.warn('meData:', meData);
      }

    } catch (err){
      console.error(err);
      msgStatus.textContent = 'Erro ao processar pagamento. Fa√ßa login e tente de novo.';
      msgStatus.style.color = 'red';
    }
  });
});
</script>
</body>
</html>
